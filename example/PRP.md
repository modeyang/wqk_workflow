# PRP (Product Requirements Paper): 每日天气预报钉钉通知工作流

## 1. 概述

**目标**: 创建一个自动化的 n8n 工作流，每日定时获取指定城市（例如：北京）的实时天气信息，并将格式化后的天气预报通过飞书群机器人发送到指定的群聊中。

**背景**: 团队成员需要每日了解天气情况以便安排出行和活动。通过自动化流程，可以替代人工查询和发送，提高效率，确保信息的及时性和准确性。

## 2. 功能需求

| 需求ID | 需求描述 | 优先级 |
|---|---|---|
| F-001 | **定时触发**：工作流需要在每天早晨固定时间（例如 8:00 AM）自动执行。 | 高 |
| F-002 | **获取天气数据**：工作流需要通过公开的天气 API，根据自动定位的城市或后备城市获取天气数据。 | 高 |
| F-003 | **数据解析与格式化**：工作流需要解析 API 返回的 JSON 数据，提取关键信息（如：城市、天气状况、温度范围、湿度、风力等），并将其格式化为易于阅读的文本消息。 | 高 |
| F-004 | **发送飞书消息**：工作流需要将格式化后的天气预报，通过飞书群机器人发送到指定的飞书群。 | 高 |
| F-005 | **错误处理**：当获取天气数据失败或发送钉钉消息失败时，工作流应能捕获错误，并可以（可选）发送错误通知给管理员。 | 中 |

## 3. 技术实现拆解

工作流将由以下 n8n 节点组成：

1.  **Schedule (Cron) 节点**: 
    *   **类型**: 触发器 (Trigger)
    *   **用途**: 用于实现 F-001，设置定时任务，每天早上 8 点触发工作流。

2.  **HTTP Request 节点 (Get Location by IP)**:
    *   **类型**: 操作 (Action)
    *   **用途**: 用于实现自动定位，向 IP-API.com 发送请求获取当前执行节点的地理位置信息。

3.  **If 节点**:
    *   **类型**: 逻辑 (Logic)
    *   **用途**: 判断上一步是否成功获取到城市信息。如果成功，则继续；如果失败，则走向后备方案。

4.  **Set 节点 (Set Fallback Location)**:
    *   **类型**: 操作 (Action)
    *   **用途**: 在定位失败时，设置一个默认的后备城市（如北京）。

5.  **HTTP Request 节点 (Get Weather)**:
    *   **类型**: 操作 (Action)
    *   **用途**: 用于实现 F-002，向第三方天气服务 API（例如心知天气、和风天气等免费API）发送 GET 请求，获取北京的天气数据。

6.  **Set 节点 (Format Message)**:
    *   **类型**: 操作 (Action)
    *   **用途**: 用于实现 F-003，对 HTTP Request 节点返回的 JSON 数据进行解析和重组，生成钉钉机器人需要的 Markdown 格式文本。

7.  **飞书节点 (n8n-nodes-feishu-lite)**:
    *   **类型**: 操作 (Action)
    *   **用途**: 用于实现 F-004，将格式化好的天气信息发送到飞书群。我们将使用社区提供的 `n8n-nodes-feishu-lite` 节点，它封装了飞书的 API，提供了更稳定和便捷的集成方式，例如可以直接发送消息卡片对象，而无需手动构建完整的 HTTP 请求。

## 4. 数据格式（示例）

**飞书消息卡片格式示例**: (飞书使用消息卡片而非简单的Markdown)

```json
{
  "msg_type": "interactive",
  "card": {
    "config": {
      "wide_screen_mode": true
    },
    "header": {
      "title": {
        "tag": "plain_text",
        "content": "每日天气预报"
      }
    },
    "elements": [
      {
        "tag": "div",
        "text": {
          "tag": "lark_md",
          "content": "**北京天气预报**\n- **天气**: 晴\n- **温度**: 15°C ~ 25°C\n- **湿度**: 40%\n- **风力**: 3级"
        }
      },
      {
        "tag": "note",
        "elements": [
          {
            "tag": "plain_text",
            "content": "今天天气不错，祝您一天好心情！"
          }
        ]
      }
    ]
  }
}
```

## 5. 交付物

1.  **`workflow.json`**: 一个可直接导入 n8n 并运行的工作流文件。
2.  **`README.md`**: 简单的说明文档，解释如何配置飞书机器人的 Webhook URL。