# N8N 工作流自动化构建项目规则

## 1. 需求分析与任务拆解

1.1. **PRP (Product Requirements Paper) 文档**：所有工作流开发必须基于 PRP 文档。PRP 文档应清晰定义工作流的目标、触发条件、执行步骤、输入输出和关键业务逻辑。
1.2. **任务拆解**：在开始开发前，必须将 PRP 文档中的需求拆解为具体的、可执行的 n8n 节点任务。明确每个节点的类型和核心参数。
1.3. **需求澄清**：如果用户需求模糊（如“设计一个工作流”），必须首先与用户沟通，或提出一个具体的、常见的场景（如“天气预报通知”、“数据同步”），获得确认后再进行任务拆解。

## 2. 节点选择与配置

2.1. **优先使用官方节点**：应优先使用 n8n 官方提供的标准节点（`n8n-nodes-base`）来完成任务。
2.2. **谨慎使用代码节点**：仅在标准节点无法满足复杂逻辑或数据转换需求时，才可使用 `Code` (之前叫 Function) 节点。代码节点中的逻辑必须清晰、高效，并添加必要的注释。
2.3. **高效查询节点**：使用 `search_nodes` 和 `get_node_essentials` MCP 工具快速查找和了解所需节点的核心功能与配置。
2.4. **配置验证**：在构建工作流之前，使用 `validate_node_minimal` 和 `validate_node_operation` 对节点的关键配置进行预验证，确保参数的正确性。

## 3. 工作流设计与开发

3.1. **模块化与可读性**：工作流应设计得清晰、易于理解。对于复杂的工作流，可以使用 `Sticky Note` 节点添加注释，解释关键步骤的逻辑。
3.2. **数据流**：清晰地管理节点之间的数据流。使用 n8n 的表达式（如 `{{ $json.data }}` 或 `{{ $node['NodeName'].json.property }}`）准确地引用前置节点的数据。
3.3. **错误处理**：为关键节点（如 API 调用、数据库操作）配置错误处理机制。启用 `Continue on Fail` 选项，并连接到错误处理分支，例如发送错误通知或记录日志。
3.4. **凭证管理**：所有敏感信息（如 API 密钥、密码）必须通过 n8n 的 `Credentials` 进行管理，严禁硬编码在节点参数中。

## 4. 验证与测试

4.1. **工作流验证**：在生成最终的 `workflow.json` 文件之前，必须使用 `validate_workflow`、`validate_workflow_connections` 和 `validate_workflow_expressions` MCP 工具对整个工作流进行全面验证。
4.2. **手动测试**：在 n8n 编辑器中手动执行工作流，检查每一步的输入输出是否符合预期。
4.3. **端到端测试**：模拟真实的触发条件，进行端到端的完整测试，确保工作流在生产环境中能够稳定运行。

## 5. 交付物

5.1. **PRP 文档**：提供一份详细的 PRP 文档，作为工作流需求的最终依据。
5.2. **`workflow.json` 文件**：提供可直接导入 n8n 实例并运行的工作流 JSON 文件。
5.3. **README.md**：提供一份简洁的 `README.md` 文件，说明工作流的用途、如何配置凭证（如果需要）以及如何触发。